rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ================= DEFAULT DENY =================
    match /{document=**} {
      allow read, write: if false;
    }

    // ================= USERS =================
    match /users/{userId} {
      allow read, write: if request.auth != null;
      
      match /devices/{deviceId} {

        // ğŸ‘€ READ PUBLIC KEY (cho E2EE)
        allow read: if request.auth != null;

        // â• CREATE DEVICE (chá»‰ chá»§ user)
        allow create: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.keys().hasOnly([
            "publicKey",
            "algorithm",
            "platform",
            "createdAt",
            "lastActiveAt"
          ])
          && request.resource.data.publicKey is string
          && request.resource.data.algorithm == "RSA-2048";

        // âœï¸ UPDATE
        // - CHá»ˆ cho update lastActiveAt
        allow update: if request.auth != null
          && request.auth.uid == userId
          && request.resource.data.diff(resource.data).changedKeys()
              .hasOnly(["lastActiveAt"]);

        // ğŸ—‘ï¸ DELETE DEVICE (revoke)
        allow delete: if request.auth != null
          && request.auth.uid == userId;
      }

    }

    // ================= TEMP CHAT ROOM =================
    match /tempChats/{roomId} {

      function isParticipant() {
        return request.auth != null
          && request.auth.uid in resource.data.participants;
      }
      
      function onlyUpdateMyAvatar() {
        // CÃ¡c field thay Ä‘á»•i
        let changed = request.resource.data.diff(resource.data).changedKeys();

        // Chá»‰ Ä‘Æ°á»£c thay Ä‘á»•i Ä‘Ãºng 1 field
        return changed.size() == 1
          && changed.hasOnly(["anonymousAvatars"])
          && request.resource.data.anonymousAvatars.keys().hasOnly(
            resource.data.anonymousAvatars.keys().union([request.auth.uid])
          )
          && request.resource.data.anonymousAvatars[request.auth.uid]
              == request.resource.data.anonymousAvatars[request.auth.uid];
      }

      // ğŸ‘€ READ temp chat room
      allow read: if request.auth != null;


      // â• Create room
      allow create: if request.auth != null
        && request.resource.data.participants is list
        && request.auth.uid in request.resource.data.participants;

      // âœï¸ Update
      allow update: if isParticipant()
        && (
          // ğŸ”¹ update cÃ¡c field há»‡ thá»‘ng
          request.resource.data.diff(resource.data).changedKeys()
            .hasOnly([
              "userALiked",
              "userBLiked",
              "typing",
              "status",
              "endedBy",
              "endedReason",
              "permanentRoomId",
              "endedAt",
            ])

          // ğŸ”¹ hoáº·c update avatar cá»§a chÃ­nh mÃ¬nh
          || (
            request.resource.data.diff(resource.data).changedKeys()
              .hasOnly(["anonymousAvatars"])
            && request.resource.data.anonymousAvatars[request.auth.uid] is string
          )
        );


      allow delete: if false;

      // ================= MESSAGES Temp =================
      match /messages/{messageId} {

        function isRoomParticipant() {
          return request.auth != null
            && request.auth.uid in
              get(/databases/$(database)/documents/tempChats/$(roomId))
                .data.participants;
        }

        allow read: if isRoomParticipant();

        allow create: if isRoomParticipant()
          && get(/databases/$(database)/documents/tempChats/$(roomId))
              .data.status == "active"
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.createdAt != null;

        allow update: if isRoomParticipant()
          && request.writeFields.size() == 1
          && request.writeFields.hasOnly([
            "reactions." + request.auth.uid
          ]);

        allow delete: if false;
      }
    }

    // ================= CHAT ROOMS =================
    match /chatRooms/{roomId} {

      function isParticipant() {
        return request.auth != null
          && request.auth.uid in resource.data.participants;
      }

      // ğŸ‘€ Ä‘á»c room
      allow read: if isParticipant();

      // â• táº¡o room (khi convert)
      allow create: if request.auth != null
        && request.resource.data.participants is list
        && request.auth.uid in request.resource.data.participants;

      allow update: if isParticipant()
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly([
            "lastMessage",
            "lastMessageType",
            "lastMessageCipher",
            "lastMessageIv",
            "lastSenderId",
            "lastMessageAt",
            "unread",
            "pinned",
            "deletedFor",
            "typing"
          ]);
      
       // ===============================
      // ğŸ” SESSION KEYS (E2EE) - KHÃ”NG ROTATE KEY
      // ===============================
      match /sessionKeys/{deviceId} {

        function isRoomParticipant() {
          return request.auth != null
            && request.auth.uid in
              get(/databases/$(database)/documents/chatRooms/$(roomId))
                .data.participants;
        }

        // âœ… Bá» epoch - chá»‰ cáº§n userId, encryptedKey, createdAt
        allow create, update: if isRoomParticipant()
          && request.resource.data.keys().hasOnly([
            "userId",
            "encryptedKey",
            "createdAt"
          ])
          && request.resource.data.userId is string
          && request.resource.data.encryptedKey is string;

        // cho phÃ©p participant Ä‘á»c
        allow read: if isRoomParticipant();

        allow delete: if false;
      }

      // ================= MESSAGES Long =================
      match /messages/{messageId} {

        function isRoomParticipant() {
          return request.auth != null
            && request.auth.uid in
              get(/databases/$(database)/documents/chatRooms/$(roomId))
                .data.participants;
        }

        // ğŸ‘€ Ä‘á»c tin nháº¯n
        allow read: if isRoomParticipant();

        // â• gá»­i / copy tin nháº¯n
        allow create: if isRoomParticipant()
          && request.resource.data.senderId is string
          && request.resource.data.createdAt != null;

        allow update: if isRoomParticipant()
          && request.writeFields.size() == 1
          && request.writeFields.hasOnly([
            "reactions." + request.auth.uid
          ]);

      }
    }

  
    match /chatRatings/{id} {

      // ğŸ‘€ Transaction cáº§n read
      allow read: if request.auth != null;

      // â• Create rating (má»—i user chá»‰ rate tá»« UID cá»§a mÃ¬nh)
      allow create: if request.auth != null
        && request.resource.data.fromUid == request.auth.uid;

      // âŒ KhÃ´ng update / delete
      allow update, delete: if false;
    }
		
    // ================= USER MATCHING REPORT =================
    match /userMatchingReports/{reportId} {

      // â• Create report
      allow create: if request.auth != null
        && request.resource.data.fromUid == request.auth.uid;

      // âŒ KhÃ´ng cho Ä‘á»c / sá»­a / xÃ³a
      allow read, update, delete: if false;
    }

  }
}

